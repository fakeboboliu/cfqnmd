<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Cloudflare Threat Score Test</title>
</head>

<body>
    <h1>Cloudflare Threat Score Test</h1>
    <p>测试你当前在 Cloudflare 的声誉 w/o tracker (and style)</p>
    <p>Inspired &amp; effected by <a href='https://lab.skk.moe/cf-threat/'>https://lab.skk.moe/cf-threat/</a></p>
    <br><br>
    <div id="threat-score">正在测试中，大概需要 5 ~ 10 秒....</div>
    <p>0 表示 Cloudflare 判定为低风险，高于 14 将无法直接访问中等安全的网站，高于
        24 将无法直接访问低安全的网站。</p>
    <h3>Request Trace</h3>
    <div id="request-info"></div>
    <h3>Use in Terminal</h3>
    <p><code style="user-select: all">curl -o- https://cf.qn.md/test.sh | bash</code></p>
    </section>
    <script>
        fetch('https://cf.qn.md/cdn-cgi/trace').then((resp) => resp.text().then(data => {
            let displays = [];
            for (let i of data.split('\n')) {
                let x = i.split('=');
                if (x[0] != '') displays.push(`<p><strong>${x[0]}:</strong> ${x[1]}</p>`);
            }
            document.getElementById('request-info').innerHTML = displays.join("");
        }))

        const runcheck = (level, max) => new Promise((resolve, reject) => {
            console.log(level);
            if (level == max) {
                reject(level);
            }
            fetch(`https://cf.qn.md/t.txt?t=${level}&${+(new Date)}`).catch(() => { reject(50); })
            .then((resp) => {
                if (!resp.ok) {
                    reject(level);
                } else { runcheck(level+1, max).catch(v => { reject(v) }) };
            })
        });

        runcheck(0, 50).then(() => {
            document.getElementById('threat-score').innerHTML = `测试失败`;
        }).catch(score => {
            let color = '';
            if (score < 5) {
                color = 'green'
            } else if (score < 20) {
                color = 'yellow'
            } else if (score <= 100) {
                color = 'red'
            }
            if (score >= 49) {
                score = '>49'
            }
            document.getElementById('threat-score').innerHTML = `你当前在 Cloudflare 的威胁指数是: <span style="font-size: xxx-large; color: ${color};">${score}</span>`;
        });
    </script>
</body>

</html>
